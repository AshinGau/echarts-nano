<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>echarts - demo</title>
    <script src="echarts.common.min.js"></script>
    <script src="jquery-3.2.1.min.js"></script>
    <script>
        function getInstruInfo(url){
            let $def = $.Deferred(),
                $pos = $.post(url); // post method
            $pos.done(data => {
                let title = [];
                for(let key in data[0])
                    if(key === 'date')
                        title.unshift(key);
                    else{
                        title.push(key);
                        for(let index in data){
                            let obj = {},
                                val = data[index][key].split(',');
                            obj.hours = +val[0];
                            obj.cnts = +val[1];
                            data[index][key] = obj;
                        }
                    }
                $def.resolve(title, data);
            });
            $pos.fail(err => { $def.reject(err); });
            return $def.promise();
        }
    </script>
</head>
<body style="width:1000px;margin:auto;">
<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
<div id="stackArea" style="width: 800px;height:500px;"></div>
<div id="pieArea" style="width: 500px;height:500px;"></div>
<div id="barArea" style="width: 800px;height:400px;"></div>
<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    let stackChart = echarts.init(document.getElementById('stackArea'));
    stackChart.showLoading();
    let pieChart = echarts.init(document.getElementById('pieArea'));
    pieChart.showLoading();
    let barChart = echarts.init(document.getElementById('barArea'));
    barChart.showLoading();
    // 指定图表的配置项和数据
    let stackOption = {
        title: {
            text: '预约机时累积分布图'
        },
        tooltip : {
            trigger: 'axis',
            axisPointer: {
                type: 'cross',
                label: {
                    backgroundColor: '#6a7985'
                }
            }
        },
        legend: {
            align: 'left',
            orient: 'vertical',
            right: 'left',
            top: '30%',
            tooltip: {
                show: true
            },
            formatter: name => echarts.format.truncateText(name, 80, '14px Microsoft Yahei', '…')
        },
        grid: {
            left: '3%',
            right: '130',
            bottom: '3%',
            containLabel: true
        },
        xAxis : [
            {
                type : 'category',
                boundaryGap : false
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ]
    };
    let pieOption = {
        title : {
            text: '设备使用分布'
        },
        tooltip : {
            trigger: 'item'
        },
        series : [
            {
                name: '机时分布',
                type: 'pie',
                radius : '60%',
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    let barOption = {
        title: {
            text: '使用机时'
        },
        tooltip : {
            trigger: 'axis',
            axisPointer : {
                type : 'shadow'
            }
        },
        legend: {
            data: ['机时', '人次']
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis : [
            {
                type : 'category',
                axisTick: {
                    alignWithLabel: true
                }
            }
        ],
        yAxis : [
            {
                type : 'value'
            }
        ],
        series : [
            {
                name:'机时',
                type:'bar',
                barWidth: '50%'
            },
            {
                name:'人次',
                type:'line',
            }
        ]
    };
    getInstruInfo('equipment.json').done((title, data) => {
        //堆积图
        stackOption.xAxis[0].data = data.map(d => d.date);
        title.shift();
        let legend = title;
        stackOption.legend.data = legend.map(d => {
            return {
                name: d,
                icon: 'rect'
            }
        });
        let series = legend.map(lg => {
            let tmp = {
                name: lg,
                type:'line',
                stack: '总量',
                areaStyle: {normal: {}},
                //data:[],
                label: {
                    emphasis: {
                        show: true,
                        position: 'top',
                        textStyle:{
                            fontSize: 15
                        }
                    }
                }
            };
            tmp.data = data.map(rd => rd[lg].hours);
            return tmp;
        });
        stackOption.series = series;
        stackChart.hideLoading();
        stackChart.setOption(stackOption);

        //饼图
        pieOption.tooltip.formatter = `${data[0].date} - ${data[legend.length - 1].date}<br/>{b} : {c}小时 ({d}%)`;
        let pieData = [];
        for(let key of legend){
            let pieObj = {};
            pieObj.name = key;
            pieObj.value = 0;
            for(let val of data)
                pieObj.value += val[key].hours;
            pieData.push(pieObj);
        }
        pieOption.series[0].data = pieData;
        pieChart.hideLoading();
        pieChart.setOption(pieOption);

        //柱状图
        barOption.series[0].data = data.map(d => d['FIB'].hours);
        barOption.series[1].data = data.map(d => d['FIB'].cnts);
        barOption.xAxis[0].data = data.map(d => d.date);
        console.log(barOption);
        barChart.hideLoading();
        barChart.setOption(barOption);
    });

</script>
</body>
</html>